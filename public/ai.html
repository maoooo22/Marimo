<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten AI Marimo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://i.postimg.cc/q7Lz6h53/favicon-marimo.png?v=99">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: #111827; }
        #chat-container::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        #chat-input { max-height: 120px; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex h-screen flex-col md:flex-row">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-gray-800 p-4 space-y-4">
            <div class="flex items-center justify-between"><span class="text-xl font-bold">Asisten AI</span><i class="fa-solid fa-robot text-sky-400"></i></div>
            <button id="new-chat-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center transition-colors"><i class="fa-solid fa-plus mr-2"></i>Chat Baru</button>
            <div class="flex-grow overflow-y-auto"><p class="text-sm text-gray-400 mb-2">Riwayat</p><nav id="history-container" class="space-y-2"><p class="text-xs text-gray-500">Fitur riwayat sedang dikembangkan.</p></nav></div>
            <div class="border-t border-gray-700 pt-4"><a href="/" class="flex items-center p-2 hover:bg-gray-700 rounded-lg transition-colors"><div class="w-8 h-8 bg-sky-500 rounded-full flex items-center justify-center font-bold text-white text-sm">M</div><span class="font-medium ml-3">Portofolio Marimo</span></a></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full">
            <header class="md:hidden flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700"><h1 class="text-lg font-bold">Asisten AI Marimo</h1><button id="menu-toggle" class="text-white"><i class="fa-solid fa-bars text-xl"></i></button></header>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div id="welcome-screen" class="text-center flex flex-col items-center justify-center h-full">
                    <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4"><i class="fa-solid fa-robot text-4xl text-sky-400"></i></div>
                    <h2 class="text-3xl font-bold mb-2">Halo! Aku Asisten AI Marimo.</h2>
                    <p class="text-gray-400 max-w-md">Tanya apa saja di kolom bawah!</p>
                </div>
            </div>
            <div class="p-4 md:p-6 bg-gray-900/80 backdrop-blur-sm">
                <div class="max-w-3xl mx-auto">
                    <form id="chat-form" class="relative">
                        <textarea id="chat-input" rows="1" class="w-full bg-gray-800 border border-gray-700 rounded-xl resize-none py-3 pl-4 pr-16 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" placeholder="Kirim pesan..."></textarea>
                        <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 bg-sky-600 hover:bg-sky-700 rounded-full flex items-center justify-center transition-colors disabled:bg-gray-600"><i class="fa-solid fa-arrow-up"></i></button>
                    </form>
                    <p class="text-xs text-gray-500 text-center mt-2">Asisten AI dapat membuat kesalahan. Pertimbangkan untuk memeriksa informasi penting.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // ... (kode UI lainnya tidak berubah) ...
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const submitButton = chatForm.querySelector('button');
        const newChatButton = document.getElementById('new-chat-button');

        let chatHistory = [];
        const systemPrompt = "Kamu adalah Asisten AI yang ramah, sedikit gaul, dan sangat membantu. Kamu berada di dalam website portofolio milik Marimo, seorang web developer muda dari Bekasi yang masih SMP. Tugasmu adalah menjawab pertanyaan pengunjung. Kamu tahu semua tentang Marimo berdasarkan konteks website ini (skill HTML, CSS, JS, Python, dan proyek NGL Bot & Bart Generator). Jawab selalu dalam Bahasa Indonesia.";
        
        function escapeHTML(str) { const p = document.createElement('p'); p.appendChild(document.createTextNode(str || '')); return p.innerHTML.replace(/\n/g, '<br>'); }
        chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; submitButton.disabled = chatInput.value.trim() === ''; });
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); } });
        submitButton.disabled = true;
        chatForm.addEventListener('submit', (e) => { e.preventDefault(); const message = chatInput.value.trim(); if (!message) return; if (welcomeScreen && !welcomeScreen.hidden) { welcomeScreen.hidden = true; } addUserMessage(message); callGeminiAPI(message); chatInput.value = ''; chatInput.style.height = 'auto'; submitButton.disabled = true; });
        function addUserMessage(message) { /* ... */ }
        function addAIMessage(message) { /* ... */ }
        function showLoadingIndicator() { /* ... */ }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
        newChatButton.addEventListener('click', () => { chatContainer.innerHTML = ''; welcomeScreen.hidden = false; chatHistory = []; });

        // <<< INI BAGIAN YANG BERUBAH >>>
        async function callGeminiAPI(prompt) {
            showLoadingIndicator();
            submitButton.disabled = true;

            chatHistory.push({ role: 'user', parts: [{ text: prompt }] });
            
            const apiUrl = '/api/chat';

            const payload = { chatHistory, systemPrompt };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Ambil respons dari backend, APA PUN ITU (sukses atau gagal)
                const result = await response.json();

                if (!response.ok) {
                    // Jika backend mengembalikan eror, tampilkan di chat
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }
                
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                document.querySelector('.ai-loading')?.remove();

                if (aiResponse) {
                    addAIMessage(aiResponse);
                    chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                } else {
                    addAIMessage('Waduh, AI-nya ngasih jawaban kosong. Aneh...');
                }
            } catch (error) {
                console.error("Gagal memanggil backend:", error);
                document.querySelector('.ai-loading')?.remove();
                // Tampilkan pesan eror langsung di chat
                addAIMessage(`Waduh, ada masalah nih: ${error.message}`);
            }
            
            submitButton.disabled = false;
        }
    </script>
</body>
</html>
